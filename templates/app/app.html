{% extends 'app/base.html' %}
{% load staticfiles %}

{% block menu_items_block %}
    <li class="menu-item">
        <a class="menu-item__link h-link-effect" href="{% url 'app:profile' %}">
            Profile
        </a> 
    </li>
    <li class="menu-item">
        <a class="menu-item__link h-link-effect" href="{% url 'app:logout' %}">
            Log out
        </a>
    </li>
{% endblock %}

{% block body_block %}

<div class="main-container">

    <div class="dasboard-container h-width">

        <h2 class="dashboard-heading h-900">Welcome back,{% if user.is_donor %} {{donor.nickname}}{% else %} {{hospital.name}}{% endif %}!</h1>

        {% if user.is_donor %}

            <div class="dashboard-menu__container">
                <div class="dashboard-block h-border-radius h-shadow h-pointer show-map">
                    <a href="{% url 'app:map'%}" class="dashboard-block__text">
                        
                        <span class="block-text__title h-900">Map</span><br />
                        Discover hospitals nearby!
                    </a>
                </div>
                <div class="dashboard-block h-border-radius h-shadow h-pointer create-booking">
                    <div class="dashboard-block__text">
                        <span class="block-text__title h-900">Book it</span><br />
                        Create an appointment at hospital you fancy!
                    </div>
                </div>

            </div>

            <div class="stories-container">
                <h2 class="dashboard-heading h-900">Most popular stories</h2>
                    {% if stories %}
                        <div class="stories-wrapper">
                            {% for story in stories %}

                            <div class="story-block">
                                    {% if story.picture %}
                                    <img src="{{ STATIC_URL }}{{ story.picture }}" alt="Story picture" class="story-pic">
                                    {% else %}
                                    <img src="{% static 'images/story_placeholder.jpg' %}" alt="Story picture" class="story-pic">
                                    {% endif %}
                                <div class="story-content">
                                    <h4 class="h-700">{{ story.heading }}</h4>
                                    <div class="story-text">{{ story.story }}</div>
                                    <div class="story-block__bar">
                                        <a href="story?id={{ story.id }}" class="story-link h-700">Read the story</a>
                                        <div class="likes-cont h-pointer" data-id="{{ story.id }}">
                                            <svg class="icon_like" role="img" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0" y="0" viewBox="0 0 128 128" enable-background="new 0 0 128 128" xml:space="preserve"><path id="heart" d="M64 127.5C17.1 79.9 3.9 62.3 1 44.4c-3.5-22 12.2-43.9 36.7-43.9 10.5 0 20 4.2 26.4 11.2 6.3-7 15.9-11.2 26.4-11.2 24.3 0 40.2 21.8 36.7 43.9C124.2 62 111.9 78.9 64 127.5zM37.6 13.4c-9.9 0-18.2 5.2-22.3 13.8C5 49.5 28.4 72 64 109.2c35.7-37.3 59-59.8 48.6-82 -4.1-8.7-12.4-13.8-22.3-13.8 -15.9 0-22.7 13-26.4 19.2C60.6 26.8 54.4 13.4 37.6 13.4z"></path>â™¥</svg>
                                            <span class="likes-count">{{ story.likes }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% endfor %}
                        
                        </div>
                    {% else %}
                        <div class="bookings-wrapper">
                            <div class="nothing-block">
                                    
                                    <div class="booking-hospital">There have been no stories posted yet.</div>

                            </div>
                        </div>

                    {% endif %}
            </div>

            <div class="bookings-container">
                    <h2 class="dashboard-heading h-900">My bookings</h2>
                
                        {% if bookings %}
                            <div class="bookings-wrapper">
                                {% for booking in bookings %}

                                    <div class="booking-block">
                
                                        <div class="booking-date">{{ booking.appointment }}</div>
                                        <div class="booking-hospital">{{ booking.hospital }}</div>
                                        <div class="booking-actions">
                                            <div class="booking-delete h-pointer h-700" data-id="{{ booking.pk }}">CANCEL</div>
                                        </div>

                                    </div>
        

                                
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="bookings-wrapper">
                                <div class="booking-block">
                                        
                                        <div class="booking-date"></div>
                                        <div class="booking-hospital">You do not have any appointment booked.</div>
                                        <div class="booking-actions">

                                        </div>

                                </div>
                            </div>
                        {% endif %}                
                </div>

                <div class="reviews-container">
                    <h2 class="dashboard-heading h-900">My reviews</h2>

                    {% if reviews %}
                        <div class="reviews-wrapper">
                            {% for review in reviews %}
                                {% if forloop.counter < 5 %}
                                    <div class="review-block">
                                        <div class="review-content">
                                            <span>Review for:</span><br />
                                            <h4 class="h-700">{{ review.hospital }}</h4>
                                            <span class="review-date">On: {{ review.date }}</span><br />
                                            <span class="review-author">By: {{ review.donor }}</span>
                                            <div class="review-text">{{ review.review }}</div>
                                            <div class="review-bar">
                                                <a href="review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                <div class="review-block fadeable h-display-none">
                                    <div class="review-content">
                                        <span>Review for:</span><br />
                                        <h4 class="h-700">{{ review.hospital }}</h4>
                                        <span class="review-date">On: {{ review.date }}</span><br />
                                        <span class="review-author">By: {{ review.donor }}</span>                                     <span class="review-author">By: {{ review.donor }}</span>
                                        <div class="review-text">{{ review.review }}</div>
                                        <div class="review-bar">
                                            <a href="review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="bookings-wrapper">
                            <div class="nothing-block">
                                    
                                <div class="booking-hospital">You have not written any review yet.</div>

                            </div>
                        </div>

                    {% endif %}
                    
                </div>

                {% if reviews|length > 4 %}
                    <div class="show-more show-more-reviews h-700" data-section="reviews-section">Show more!</div>
                {% endif %}


        {% else %}

        <div class="dashboard-menu__container">
                <div class="dashboard-block h-border-radius h-shadow h-pointer show-map">
                    <a href="{% url 'app:map'%}" class="dashboard-block__text">
                        
                        <span class="block-text__title h-900">Story</span><br />
                        Write a story to engage with donors!
                    </a>
                </div>
                <div class="dashboard-block h-border-radius h-shadow h-pointer show-map">
                    <a href="{% url 'app:map' %}" class="dashboard-block__text">
                        <span class="block-text__title h-900">Map</span><br />
                        Look which other hospitals joined!
                    </a>
                </div>

            </div>

            <div class="bookings-container">
                <h2 class="dashboard-heading h-900">Notify donors</h2>
            
                    <div class="bookings-wrapper">
                        <div class="notify-block">
                                {% csrf_token %}

                                <div class="booking-date">Select blood type you need</div>
                                <div class="booking-hospital">
                                    <select name="notify_type" id="notify_field" required>
                                        <option value="" disabled>Needed blood type</option>
                                        <option value="NO">We do not need any right now</option>
                                        <option value="O+">O positive</option>
                                        <option value="O-">O negative</option>
                                        <option value="A+">A positive</option>
                                        <option value="A-">A negative</option>
                                        <option value="B+">B positive</option>
                                        <option value="B-">B negative</option>
                                        <option value="AB+">AB positive</option>
                                        <option value="AB-">AB negative</option>
                                    </select>
                                </div>
                                <div class="booking-actions">
                                    <div class="notify-donors h-pointer h-700"">Notify them</div>
                                </div>

                        </div>
                    </div>           
            </div>

            <div class="bookings-container">
                <h2 class="dashboard-heading h-900">Bookings</h2>
            
                    {% if bookings %}
                        <div class="bookings-wrapper">
                            {% for booking in bookings %}

                                <div class="booking-block">
            
                                    <div class="booking-date">{{ booking.appointment }}</div>
                                    <div class="booking-hospital">{{ booking.hospital }}</div>
                                    <div class="booking-actions">
                                        <div class="booking-delete h-pointer h-700" data-id="{{ booking.pk }}">CANCEL</div>
                                    </div>

                                </div>
    

                            
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="bookings-wrapper">
                                <div class="nothing-block">
                                    
                                    <div class="booking-hospital">You do not have any appointment booked.</div>

                            </div>
                        </div>
                    {% endif %}                
            </div>

            <div class="stories-container">
                <h2 class="dashboard-heading h-900">My stories</h2>
                    {% if stories %}
                        <div class="stories-wrapper">
                            {% for story in stories %}

                                {% if forloop.counter < 5 %}

                                    <div class="story-block">
                                        {% if story.picture %}
                                        <img src="{{ STATIC_URL }}{{ story.picture }}" alt="Story picture" class="story-pic">
                                        {% else %}
                                        <img src="{% static 'images/story_placeholder.jpg' %}" alt="Story picture" class="story-pic">
                                        {% endif %}
                                        
                                        <div class="story-content">
                                            <h4 class="h-700">{{ story.heading }}</h4>
                                            <div class="story-text">{{ story.story }}</div>
                                            <div class="story-block__bar">
                                                <a href="story?id={{ story.id }}" class="story-link h-700">Read the story</a>
                                                <div class="likes-cont h-pointer" data-id="{{ story.id }}">
                                                    <svg class="icon_like" role="img" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0" y="0" viewBox="0 0 128 128" enable-background="new 0 0 128 128" xml:space="preserve"><path id="heart" d="M64 127.5C17.1 79.9 3.9 62.3 1 44.4c-3.5-22 12.2-43.9 36.7-43.9 10.5 0 20 4.2 26.4 11.2 6.3-7 15.9-11.2 26.4-11.2 24.3 0 40.2 21.8 36.7 43.9C124.2 62 111.9 78.9 64 127.5zM37.6 13.4c-9.9 0-18.2 5.2-22.3 13.8C5 49.5 28.4 72 64 109.2c35.7-37.3 59-59.8 48.6-82 -4.1-8.7-12.4-13.8-22.3-13.8 -15.9 0-22.7 13-26.4 19.2C60.6 26.8 54.4 13.4 37.6 13.4z"></path>â™¥</svg>
                                                    <span class="likes-count">{{ story.likes }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="story-block fadeable h-display-none">
                                        {% if story.picture %}
                                        <img src="{% static '{{ story.picture }}' %}" alt="Story picture" class="story-pic">
                                        {% else %}
                                        <img src="{% static 'images/story_placeholder.jpg' %}" alt="Story picture" class="story-pic">
                                        {% endif %}
                                        <div class="story-content">
                                            <h4 class="h-700">{{ story.heading }}</h4>
                                            <div class="story-text">{{ story.story }}</div>
                                            <div class="story-block__bar">
                                                <a href="story?id={{ story.id }}" class="story-link h-700">Read the story</a>
                                                <div class="likes-cont h-pointer" data-id="{{ story.id }}">
                                                    <svg class="icon_like" role="img" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0" y="0" viewBox="0 0 128 128" enable-background="new 0 0 128 128" xml:space="preserve"><path id="heart" d="M64 127.5C17.1 79.9 3.9 62.3 1 44.4c-3.5-22 12.2-43.9 36.7-43.9 10.5 0 20 4.2 26.4 11.2 6.3-7 15.9-11.2 26.4-11.2 24.3 0 40.2 21.8 36.7 43.9C124.2 62 111.9 78.9 64 127.5zM37.6 13.4c-9.9 0-18.2 5.2-22.3 13.8C5 49.5 28.4 72 64 109.2c35.7-37.3 59-59.8 48.6-82 -4.1-8.7-12.4-13.8-22.3-13.8 -15.9 0-22.7 13-26.4 19.2C60.6 26.8 54.4 13.4 37.6 13.4z"></path>â™¥</svg>
                                                    <span class="likes-count">{{ story.likes }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                {% endif %}
                            
                            {% endfor %}
                        
                        </div>

                        {% if stories|length > 4 %}
                            <div class="show-more show-more-stories h-700" data-section="stories-section">Show more!</div>
                        {% endif %}

                    {% else %}
                        <div class="bookings-wrapper">
                            <div class="nothing-block">
                                    
                                    <div class="booking-hospital">There have been no stories posted yet.</div>

                            </div>
                        </div>

                    {% endif %}
            </div>

            <div class="reviews-container">
                <h2 class="dashboard-heading h-900">My reviews</h2>

                {% if reviews %}
                    <div class="reviews-wrapper">
                        {% for review in reviews %}
                            {% if forloop.counter < 5 %}
                                <div class="review-block">
                                    <div class="review-content">
                                        <span>Review for:</span><br />
                                        <h4 class="h-700">{{ review.hospital }}</h4>
                                        <span class="review-date">On: {{ review.date }}</span>
                                        <div class="review-text">{{ review.review }}</div>
                                        <div class="review-bar">
                                            <a href="review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                            <div class="review-block fadeable h-display-none">
                                <div class="review-content">
                                    <span>Review for:</span><br />
                                    <h4 class="h-700">{{ review.hospital }}</h4>
                                    <span class="review-date">On: {{ review.date }}</span>
                                    <div class="review-text">{{ review.review }}</div>
                                    <div class="review-bar">
                                        <a href="review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="bookings-wrapper">
                        <div class="nothing-block">
                                
                            <div class="booking-hospital">You have not written any review yet.</div>

                        </div>
                    </div>

                {% endif %}
                
            </div>

            {% if reviews|length > 4 %}
                <div class="show-more show-more-reviews h-700" data-section="reviews-section">Show more!</div>
            {% endif %}


        {% endif %}

    </div>
</div>

<div class="modal-wrapper cancel-booking__modal" data-name="modal">
    <div class="modal-container">
        <div class="modal-content__msg h-700">Do you really want to cancel this booking?</div>
        <div class="modal-buttons__cont">
            <div class="modal-button h-pointer h-uppercase cancel-modal__close h-link-effect-primary h-700">
                Close
            </div>
            <div class="modal-button h-pointer h-uppercase cancel-booking__btn h-link-effect-primary h-700">
                cancel it
            </div>
        </div>
    </div>
</div>

<div class="modal-wrapper notify-donors__modal" data-name="modal">
    <div class="modal-container">
        <div class="modal-content__msg h-700"></div>
        <div class="modal-buttons__cont">
            <div class="modal-button h-pointer h-uppercase notify-donors__close h-link-effect-primary h-700">
                Close
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block javascript_block %}

<script>

$(document).ready(function() {

    var notify = "{{ hospital.notified_types }}";
    console.log(notify)
    if(notify != "") {
        $('#notify_field option[value="'+notify+'"]').attr('selected', 'selected')
    }

    

    var booking_to_cancel = -1;

    // Get only 40 words of the story text
    function ellipsizeTextBox(e) {

        var wordArray = e.html().split(' ');
        if (wordArray.length > 39){
            var newArray = [];
            var i = 0;
            while(i < 40) {
                newArray.push(wordArray[i]);
                i++;
            }
            e.html(newArray.join(' ') + '...');
        }
    }

    // Trim the text for all the texts
    $(".story-text").each(function() {
        ellipsizeTextBox($(this));
    })

    // Trim the text for all the texts
    $(".review-text").each(function() {
        ellipsizeTextBox($(this));
    })

    // Notify donors with hte given blood type
    $(".notify-donors").click(function () {

        var notify_type = $("#notify_field").val();
        var csrftoken = getCookie('csrftoken');

        $.ajax({
            type: "POST",
            headers: {'X-CSRFToken' : csrftoken},
            url: "notify_donors/",
            dataType: "json",
            data: {"type": notify_type},
            success: function(response) {
                console.log(response)
                if (response.success) {
                    $(".notify-donors__modal .modal-content__msg").html(response.message);
                    
                } else {
                    // Error handling
                    $(".notify-donors__modal .modal-content__msg").html(response.message);

                }
                // Show a modal with information about the signup process
                $(".notify-donors__modal").toggleClass("modal-open");
                // disable scrolling when modal is on
                $("html").css("overflow", "hidden");

            }
        })

        });

    // Open confirmation modal for booking cancellation
    $(".booking-delete").click(function () {

        booking_to_cancel =  $(this).data("id");

        $(".cancel-booking__modal").toggleClass("modal-open");
        $("html").css("overflow", "hidden");

    });

    // Cancel the given booking
    $(".cancel-booking__btn").click(function () {

        // TODO Cancel booking

        if(booking_to_cancel != -1) {

            $.ajax({
                type: "POST",
                url: "cancel_booking?id="+booking_to_cancel,
                dataType: "json",
                async: false,
                success: function(response) {
                    console.log(response)
                }
            })
        }
        

        $(".cancel-booking__modal").toggleClass("modal-open");
        $("html").css("overflow", "auto");

    
    });
     // Close open cancel modal
    $(".cancel-modal__close").click(function () {
        
        $(".cancel-booking__modal").toggleClass("modal-open");
        $("html").css("overflow", "auto");
    
    });
     // Close open notify modal 
     $(".notify-donors__close").click(function () {
        
        $(".notify-donors__modal").toggleClass("modal-open");
        $("html").css("overflow", "auto");
    
    });
    // Close the modal by clicking around the diaglog box
    $(".modal-wrapper").click(function (e) {

        if (e.target.dataset["name"] == "modal") {
            $(this).toggleClass("modal-open");
            $("html").css("overflow", "auto");
        }

    });

    // Show more reviews
    $(".show-more-reviews").click(function () {
        if($(".reviews-wrapper").find(".fadeable").hasClass("h-display-none")) {
            $(this).text("Show less!");
        } else {
            $(this).text("Show more!");
        }
        $(".reviews-wrapper").find(".fadeable").toggleClass("h-display-none");
    });

    // Show more stories
    $(".show-more-stories").click(function () {
        if($(".stories-wrapper").find(".fadeable").hasClass("h-display-none")) {
            $(this).text("Show less!");
        } else {
            $(this).text("Show more!");
        }
        $(".stories-wrapper").find(".fadeable").toggleClass("h-display-none");
    });


})
</script>
{% endblock %}