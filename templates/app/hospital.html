{% extends 'app/base.html' %}
{% load staticfiles %}

{% block menu_items_block %}
    <li class="menu-item">
        <a class="menu-item__link h-link-effect" href="{% url 'app:app' %}">
            Dashboard
        </a> 
    </li> 
    <li class="menu-item">
        <a class="menu-item__link h-link-effect" href="{% url 'app:profile' %}">
            Profile
        </a> 
    </li>
    <li class="menu-item">
        <a class="menu-item__link h-link-effect" href="{% url 'app:logout' %}">
            Log out
        </a>
    </li>
{% endblock %}

{% block body_block %}

<div class="main-container">

    <div class="dasboard-container h-width">

        <h4 class="back-link"><a href="{% url 'app:app'%}"><svg class="arrow-back" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M5 3l3.057-3 11.943 12-11.943 12-3.057-3 9-9z"/></svg>Back to dashboard</a></h4>

        <h2 class="dashboard-heading h-900">{{hospital.name}}</h1>

        {% if user.is_donor %}

            <div class="dashboard-menu__container">
                <div class="dashboard-block h-border-radius h-shadow h-pointer show-map">
                    <a href="{% url 'app:map'%}" class="dashboard-block__text">
                        
                        <span class="block-text__title h-900">Book it!</span><br />
                        Book an appointment for next days!
                    </a>
                </div>
                <div class="dashboard-block h-border-radius h-shadow h-pointer write-review_btn">
                    <div class="dashboard-block__text">
                        <span class="block-text__title h-900">Review it!</span><br />
                        Describe your experience for other users!
                    </div>
                </div>

            </div>

            <div class="bookings-container map-container">
                    <h2 class="dashboard-heading h-900">Where to find this hospital</h2>
                    <div id="mapid" style="width: 100%; height: 300px"></div>
                </div>

            <div class="stories-container">
                <h2 class="dashboard-heading h-900">Stories by this hospital</h2>
                {% if stories %}
                <div class="stories-wrapper">
                    {% for story in stories %}

                        {% if forloop.counter < 5 %}

                            <div class="story-block">
                                {% if story.picture %}
                                <img src="{{ STATIC_URL }}{{ story.picture }}" alt="Story picture" class="story-pic">
                                {% else %}
                                <img src="{% static 'images/story_placeholder.jpg' %}" alt="Story picture" class="story-pic">
                                {% endif %}
                                
                                <div class="story-content">
                                    <h4 class="h-700">{{ story.heading }}</h4>
                                    <div class="story-text">{{ story.story }}</div>
                                    <div class="story-block__bar">
                                        <a href="../../story?id={{ story.id }}" class="story-link h-700">Read the story</a>
                                        <div class="likes-cont h-pointer" data-id="{{ story.id }}">
                                            <svg class="icon_like" role="img" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0" y="0" viewBox="0 0 128 128" enable-background="new 0 0 128 128" xml:space="preserve"><path id="heart" d="M64 127.5C17.1 79.9 3.9 62.3 1 44.4c-3.5-22 12.2-43.9 36.7-43.9 10.5 0 20 4.2 26.4 11.2 6.3-7 15.9-11.2 26.4-11.2 24.3 0 40.2 21.8 36.7 43.9C124.2 62 111.9 78.9 64 127.5zM37.6 13.4c-9.9 0-18.2 5.2-22.3 13.8C5 49.5 28.4 72 64 109.2c35.7-37.3 59-59.8 48.6-82 -4.1-8.7-12.4-13.8-22.3-13.8 -15.9 0-22.7 13-26.4 19.2C60.6 26.8 54.4 13.4 37.6 13.4z"></path>♥</svg>
                                            <span class="likes-count">{{ story.likes }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="story-block fadeable h-display-none">
                                {% if story.picture %}
                                <img src="{{ STATIC_URL }}{{ story.picture }}" alt="Story picture" class="story-pic">
                                {% else %}
                                <img src="{% static 'images/story_placeholder.jpg' %}" alt="Story picture" class="story-pic">
                                {% endif %}
                                <div class="story-content">
                                    <h4 class="h-700">{{ story.heading }}</h4>
                                    <div class="story-text">{{ story.story }}</div>
                                    <div class="story-block__bar">
                                        <a href="../../story?id={{ story.id }}" class="story-link h-700">Read the story</a>
                                        <div class="likes-cont h-pointer" data-id="{{ story.id }}">
                                            <svg class="icon_like" role="img" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0" y="0" viewBox="0 0 128 128" enable-background="new 0 0 128 128" xml:space="preserve"><path id="heart" d="M64 127.5C17.1 79.9 3.9 62.3 1 44.4c-3.5-22 12.2-43.9 36.7-43.9 10.5 0 20 4.2 26.4 11.2 6.3-7 15.9-11.2 26.4-11.2 24.3 0 40.2 21.8 36.7 43.9C124.2 62 111.9 78.9 64 127.5zM37.6 13.4c-9.9 0-18.2 5.2-22.3 13.8C5 49.5 28.4 72 64 109.2c35.7-37.3 59-59.8 48.6-82 -4.1-8.7-12.4-13.8-22.3-13.8 -15.9 0-22.7 13-26.4 19.2C60.6 26.8 54.4 13.4 37.6 13.4z"></path>♥</svg>
                                            <span class="likes-count">{{ story.likes }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        {% endif %}
                    
                    {% endfor %}
                
                </div>

                {% if stories|length > 4 %}
                    <div class="show-more show-more-stories h-700" data-section="stories-section">Show more!</div>
                {% endif %}

            {% else %}
                <div class="bookings-wrapper">
                    <div class="nothing-block">
                            
                        <div class="booking-hospital">There has been no stories posted by this hospital yet.</div>

                    </div>
                </div>

            {% endif %}
            </div>

            <div class="reviews-container">
                <h2 class="dashboard-heading h-900">Reviews of this hospital</h2>

                {% if reviews %}
                    <div class="reviews-wrapper">
                        {% for review in reviews %}
                            {% if forloop.counter < 5 %}
                                <div class="review-block">
                                    <div class="review-content">
                                        <span>Review for:</span><br />
                                        <h4 class="h-700">{{ review.hospital }}</h4>
                                        <span class="review-date">On: {{ review.date }}</span>
                                        <span class="review-author">By: {{ review.donor }}</span>
                                        <div class="review-text">{{ review.review }}</div>
                                        <div class="review-bar">
                                            <a href="../../review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                            <div class="review-block fadeable h-display-none">
                                <div class="review-content">
                                    <span>Review for:</span><br />
                                    <h4 class="h-700">{{ review.hospital }}</h4>
                                    <span class="review-date">On: {{ review.date }}</span>
                                    <span class="review-author">By: {{ review.donor }}</span>
                                    <div class="review-text">{{ review.review }}</div>
                                    <div class="review-bar">
                                        <a href="../../review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="bookings-wrapper">
                        <div class="nothing-block">
                            
                            <div class="booking-hospital">Nobody has reviewed this hospital yet.</div>

                        </div>
                    </div>

                {% endif %}
                
            </div>

            {% if reviews|length > 4 %}
                <div class="show-more show-more-reviews h-700" data-section="reviews-section">Show more!</div>
            {% endif %}


        {% else %}
            <div class="bookings-container map-container">
                <h2 class="dashboard-heading h-900">Where to find this hospital</h2>
                <div id="mapid" style="width: 100%; height: 300px"></div>
            </div>

            <div class="stories-container">
                <h2 class="dashboard-heading h-900">Stories by this hospital</h2>
                    {% if stories %}
                        <div class="stories-wrapper">
                            {% for story in stories %}
                                {% if forloop.counter < 5 %}
                                    <div class="story-block">
                                        {% if story.picture %}
                                        <img src="{{ STATIC_URL }}{{ story.picture }}" alt="Story picture" class="story-pic">
                                        {% else %}
                                        <img src="{% static 'images/story_placeholder.jpg' %}" alt="Story picture" class="story-pic">
                                        {% endif %}
                                        
                                        <div class="story-content">
                                            <h4 class="h-700">{{ story.heading }}</h4>
                                            <div class="story-text">{{ story.story }}</div>
                                            <div class="story-block__bar">
                                                <a href="../../story?id={{ story.id }}" class="story-link h-700">Read the story</a>
                                                <div class="likes-cont h-pointer" data-id="{{ story.id }}">
                                                    <svg class="icon_like" role="img" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0" y="0" viewBox="0 0 128 128" enable-background="new 0 0 128 128" xml:space="preserve"><path id="heart" d="M64 127.5C17.1 79.9 3.9 62.3 1 44.4c-3.5-22 12.2-43.9 36.7-43.9 10.5 0 20 4.2 26.4 11.2 6.3-7 15.9-11.2 26.4-11.2 24.3 0 40.2 21.8 36.7 43.9C124.2 62 111.9 78.9 64 127.5zM37.6 13.4c-9.9 0-18.2 5.2-22.3 13.8C5 49.5 28.4 72 64 109.2c35.7-37.3 59-59.8 48.6-82 -4.1-8.7-12.4-13.8-22.3-13.8 -15.9 0-22.7 13-26.4 19.2C60.6 26.8 54.4 13.4 37.6 13.4z"></path>♥</svg>
                                                    <span class="likes-count">{{ story.likes }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="story-block fadeable h-display-none">
                                        {% if story.picture %}
                                        <img src="{{ STATIC_URL }}{{ story.picture }}" alt="Story picture" class="story-pic">
                                        {% else %}
                                        <img src="{% static 'images/story_placeholder.jpg' %}" alt="Story picture" class="story-pic">
                                        {% endif %}
                                        <div class="story-content">
                                            <h4 class="h-700">{{ story.heading }}</h4>
                                            <div class="story-text">{{ story.story }}</div>
                                            <div class="story-block__bar">
                                                <a href="../../story?id={{ story.id }}" class="story-link h-700">Read the story</a>
                                                <div class="likes-cont h-pointer" data-id="{{ story.id }}">
                                                    <svg class="icon_like" role="img" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0" y="0" viewBox="0 0 128 128" enable-background="new 0 0 128 128" xml:space="preserve"><path id="heart" d="M64 127.5C17.1 79.9 3.9 62.3 1 44.4c-3.5-22 12.2-43.9 36.7-43.9 10.5 0 20 4.2 26.4 11.2 6.3-7 15.9-11.2 26.4-11.2 24.3 0 40.2 21.8 36.7 43.9C124.2 62 111.9 78.9 64 127.5zM37.6 13.4c-9.9 0-18.2 5.2-22.3 13.8C5 49.5 28.4 72 64 109.2c35.7-37.3 59-59.8 48.6-82 -4.1-8.7-12.4-13.8-22.3-13.8 -15.9 0-22.7 13-26.4 19.2C60.6 26.8 54.4 13.4 37.6 13.4z"></path>♥</svg>
                                                    <span class="likes-count">{{ story.likes }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                {% endif %}
                            
                            {% endfor %}
                        
                        </div>

                        {% if stories|length > 4 %}
                            <div class="show-more show-more-stories h-700" data-section="stories-section">Show more!</div>
                        {% endif %}

                    {% else %}
                        <div class="bookings-wrapper">
                            <div class="nothing-block">
                                    
                                    <div class="booking-hospital">There have been no stories posted yet.</div>

                            </div>
                        </div>

                    {% endif %}
            </div>

            <div class="reviews-container">
                <h2 class="dashboard-heading h-900">Reviews of this hospital</h2>

                {% if reviews %}
                    <div class="reviews-wrapper">
                        {% for review in reviews %}
                            {% if forloop.counter < 5 %}
                                <div class="review-block">
                                    <div class="review-content">
                                        <span>Review for:</span><br />
                                        <h4 class="h-700">{{ review.hospital }}</h4>
                                        <span class="review-date">On: {{ review.date }}</span>
                                        <div class="review-text">{{ review.review }}</div>
                                        <div class="review-bar">
                                            <a href="../../review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                            <div class="review-block fadeable h-display-none">
                                <div class="review-content">
                                    <span>Review for:</span><br />
                                    <h4 class="h-700">{{ review.hospital }}</h4>
                                    <span class="review-date">On: {{ review.date }}</span>
                                    <div class="review-text">{{ review.review }}</div>
                                    <div class="review-bar">
                                        <a href="../../review?id={{ review.id }}" class="review-btn h-700">Read more!</a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="bookings-wrapper">
                        <div class="nothing-block">
                                
                            <div class="booking-hospital">You have not written any review yet.</div>

                        </div>
                    </div>

                {% endif %}
                
            </div>

            {% if reviews|length > 4 %}
                <div class="show-more show-more-reviews h-700" data-section="reviews-section">Show more!</div>
            {% endif %}


        {% endif %}

    </div>
</div>

<div class="modal-wrapper write-review__modal" data-name="modal">
    <div class="modal-container">
        {% csrf_token %}
        <div class="modal-content__msg">
            <label for="review_field">Your review of this hospital:</label>
            <textarea name="review_field" id="review_field" cols="30" rows="10"></textarea>
        </div>
        <div class="modal-buttons__cont">
            <div class="modal-button h-pointer h-uppercase review-modal__close h-link-effect-primary h-700">
                Close
            </div>
            <div class="modal-button h-pointer h-uppercase write-review__btn h-link-effect-primary h-700">
                Send the review
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block javascript_block %}

<script>

$(document).ready(function() {

    var booking_to_cancel = -1;

    var hospital_id = "{{ user.id }}";

    // Get only 40 words of the story text
    function ellipsizeTextBox(e) {

        var wordArray = e.html().split(' ');
        if (wordArray.length > 39){
            var newArray = [];
            var i = 0;
            while(i < 40) {
                newArray.push(wordArray[i]);
                i++;
            }
            e.html(newArray.join(' ') + '...');
        }
    }

    // Trim the text for all the texts
    $(".story-text").each(function() {
        ellipsizeTextBox($(this));
    })

    // Trim the text for all the texts
    $(".review-text").each(function() {
        ellipsizeTextBox($(this));
    })

    // Open modal for review creation
    $(".write-review_btn").click(function () {

        $(".write-review__modal").toggleClass("modal-open");
        $("html").css("overflow", "hidden");

    });

    // Write an review
    $(".write-review__btn").click(function () {

        // TODO Cancel booking
        var csrftoken = getCookie('csrftoken');

        var donor_id = "{{ user.id }}";
        var hospital_id = "{{ hospital.pk }}";
        var review_text = $("#review_field").val();

        console.log(review_text)
        // Reset the error
        $("#review_field").removeClass("h-empty");
        
        // check if the required fields are filled
        if(review_text == "") {
            $("#review_field").addClass("h-empty");
            return;
        }

        // Get well formatted today's date
        var date = new Date(Date.now()).toISOString().split('T')[0]

        var data = {'review_text': review_text,
                    'time': date,
                    'donor': donor_id,
                    'hospital': hospital_id
                    }
                    console.log(data)
        $.ajax({
            type: "POST",
            headers: {'X-CSRFToken' : csrftoken},
            url: "{% url 'app:write_review' %}",
            data: data,
            // dataType: "json",
            success: function(response) {
                console.log("sent")
                console.log(response)
                if(response.success) {

                } else {

                }
            }
        })


        $(".write-review__modal").toggleClass("modal-open");
        $("html").css("overflow", "auto");


    });

    // Open confirmation modal for booking cancellation
    $(".booking-delete").click(function () {

        booking_to_cancel =  $(this).data("id");

        $(".cancel-booking__modal").toggleClass("modal-open");
        $("html").css("overflow", "hidden");

    });

    // Cancel the given booking
    $(".cancel-booking__btn").click(function () {

        // TODO Cancel booking

        if(booking_to_cancel != -1) {

            $.ajax({
                url: "cancel_booking?id="+booking_to_cancel,
                dataType: "json",
                async: false,
                success: function(response) {
                    console.log(response)
                }
            })
        }
        
        $(".modal-wrapper").toggleClass("modal-open");
        $("html").css("overflow", "auto");

    
    });
     // Close open modal
    $(".review-modal__close").click(function () {
        
        $(".write-review__modal").toggleClass("modal-open");
        $("html").css("overflow", "auto");
    
    });
    // Close the modal by clicking around the diaglog box
    $(".modal-wrapper").click(function (e) {

        if (e.target.dataset["name"] == "modal") {
            $(this).toggleClass("modal-open");
            $("html").css("overflow", "auto");
        }

    });

    // Show more reviews
    $(".show-more-reviews").click(function () {
        if($(".reviews-wrapper").find(".fadeable").hasClass("h-display-none")) {
            $(this).text("Show less!");
        } else {
            $(this).text("Show more!");
        }
        $(".reviews-wrapper").find(".fadeable").toggleClass("h-display-none");
    });

    // Show more stories
    $(".show-more-stories").click(function () {
        if($(".stories-wrapper").find(".fadeable").hasClass("h-display-none")) {
            $(this).text("Show less!");
        } else {
            $(this).text("Show more!");
        }
        $(".stories-wrapper").find(".fadeable").toggleClass("h-display-none");
    });

    // Map setup
    var loc_raw = "{{ hospital.location }}";
    var hospital_name = "{{ hospital }}";
    var loc = JSON.parse(loc_raw.replace(/&quot;/g,'"'));

    var map = L.map('mapid',{ center: [loc["lat"], loc["lon"]], zoom: 8});

    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

    var marker = new L.marker([loc["lat"], loc["lon"]], title = hospital_name);
    marker.addTo(map);


})
</script>
{% endblock %}